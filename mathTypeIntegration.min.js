var eventListenerAttached = !1;
function getImageHTML(e) {
  return `<img align="middle" src="${
    e.imgSrc
  }" data-mathml="${e.mathML.replaceAll(
    '"',
    "'"
  )}" role="math" style="max-width: none; vertical-align: -4px;">`;
}
function closeIframe(e) {
  document.getElementById("mathType-" + e).style.display = "none";
}
function openIFrame(e) {
  var t = document.getElementById("mathType-" + e);
  (t.style.display = "block"),
    (t.style =
      "bottom: 0px;right: 10px;height: 422px;width: 700px;border: 1px solid lightgrey;background: #fafafa;z-index: 999999;position: fixed;bottom: 3px;right: 3px;box-shadow: rgb(0 0 0 / 16%) 0px 3px 8px 6px;display: block; border-radius: 3%;");
}
var isPluginCommSet = {};
function setIframeCommunication(e) {
  var t,
    a = window.frames["mathType-" + e.id];
  a.postMessage({ action: "setCommunication", data: "" }, "*"),
    !isPluginCommSet[e.id] &&
      ((isPluginCommSet[e.id] = !0),
      (t = e),
      window.addEventListener("message", function e(i) {
        switch (
          (console.log("event.data.action", i.data.action),
          (eventListenerAttached = !0),
          i.data.action)
        ) {
          case "closeIFrame":
            closeIframe(t.id, e);
            break;
          case "openIFrame":
            openIFrame(t.id);
            break;
          case "insertImage":
            t.insertContent(getImageHTML(i.data.data)),
              t.contentWindow.document.addEventListener("click", (e) => {
                "img" === e.target.tagName.toLowerCase() &&
                  a.postMessage(
                    {
                      action: "insertMathML",
                      data: `${e.target.getAttribute("data-mathml")}`,
                    },
                    "*"
                  );
              }),
              closeIframe(t.id, e);
        }
      }));
}
tinymce.PluginManager.add("MathType", function (e) {
  return (
    closeIframe(e.id),
    e.ui.registry.addButton("mathtype", {
      text: "MathType",
      onAction() {
        openIFrame(e.id), setIframeCommunication(e);
      },
    }),
    { getMetadata: () => ({ name: "MathType plugin" }) }
  );
});
